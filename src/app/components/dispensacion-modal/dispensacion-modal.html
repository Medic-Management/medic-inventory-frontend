@if (isOpen) {
  <div class="modal-overlay" (click)="onClose()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2 class="modal-title">Dispensar Medicamento</h2>

      <div class="product-info">
        <p class="product-name">{{ productName }}</p>
      </div>

      @if (errorMessage) {
        <div class="alert alert-error">
          {{ errorMessage }}
        </div>
      }

      <!-- HU-11 Escenario 2: Mensaje FEFO -->
      @if (lotes.length > 0) {
        <div class="alert alert-info" style="background-color: #e0f2fe; border-left: 4px solid #0ea5e9; padding: 12px; margin-bottom: 16px; border-radius: 6px;">
          <strong>üí° Sugerencia FEFO:</strong> Los lotes est√°n ordenados por fecha de vencimiento.
          Se recomienda usar el primero (vence m√°s pronto) para evitar p√©rdidas.
        </div>
      }

      <form class="dispensacion-form" (ngSubmit)="onSubmit()">
        
        <div class="form-group">
          <label for="lote">Lote *</label>
          <select
            id="lote"
            class="form-control"
            [(ngModel)]="formData.loteId"
            name="loteId"
            [disabled]="loadingLotes"
            required>
            <option [value]="0">{{ loadingLotes ? 'Cargando lotes...' : 'Seleccione un lote' }}</option>
            @for (lote of lotes; track lote.id; let idx = $index) {
              <option [value]="lote.id">
                {{ idx === 0 ? 'üèÜ RECOMENDADO - ' : '' }}{{ lote.codigoLote }} - Vence: {{ lote.fechaVencimiento }} ({{ lote.diasHastaVencimiento }} d√≠as) - Stock: {{ lote.cantidadDisponible }}
              </option>
            }
          </select>
        </div>

        
        <div class="form-group">
          <label for="cantidad">Cantidad *</label>
          <input
            type="number"
            id="cantidad"
            class="form-control"
            placeholder="Ingrese la cantidad"
            [(ngModel)]="formData.cantidad"
            name="cantidad"
            min="1"
            required
          />
        </div>

        
        <div class="form-group">
          <label for="documento">Documento de Referencia</label>
          <input
            type="text"
            id="documento"
            class="form-control"
            placeholder="Ej: Receta m√©dica #123"
            [(ngModel)]="formData.documentoReferencia"
            name="documentoReferencia"
          />
        </div>

        
        <div class="form-group">
          <label for="motivo">Motivo / Observaciones</label>
          <textarea
            id="motivo"
            class="form-control"
            placeholder="Indicaciones o motivo de la dispensaci√≥n..."
            [(ngModel)]="formData.motivo"
            name="motivo"
            rows="3"
          ></textarea>
        </div>

        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="onClose()" [disabled]="isSubmitting">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || loadingLotes">
            {{ isSubmitting ? 'Guardando...' : 'Registrar Dispensaci√≥n' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}
