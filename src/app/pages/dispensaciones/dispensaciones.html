<div class="dispensaciones-page">
  <div class="page-header">
    <h1>Dispensación de Medicamentos</h1>
    <button class="btn btn-primary" (click)="toggleForm()">
      {{ showForm ? 'Cancelar' : '+ Nueva Dispensación' }}
    </button>
  </div>

  @if (successMessage) {
    <div class="alert alert-success">
      {{ successMessage }}
    </div>
  }

  @if (errorMessage) {
    <div class="alert alert-error">
      {{ errorMessage }}
    </div>
  }

  @if (showForm) {
    <div class="form-card">
      <h2>Registrar Nueva Dispensación</h2>
      <form (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <div class="form-group">
            <label for="producto">Producto *</label>
            <select
              id="producto"
              [(ngModel)]="formData.productoId"
              name="productoId"
              (change)="onProductoChange()"
              required>
              <option value="0">Seleccione un producto</option>
              @for (producto of productos; track producto.id) {
                <option [value]="producto.id">{{ producto.nombre || producto.codigo }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="lote">Lote * (ordenado por FEFO - First Expired, First Out)</label>
            <select
              id="lote"
              [(ngModel)]="formData.loteId"
              name="loteId"
              [disabled]="!formData.productoId || loadingLotes"
              required>
              <option value="0">{{ loadingLotes ? 'Cargando...' : 'Seleccione un lote' }}</option>
              @for (lote of lotes; track lote.id; let i = $index) {
                <option [value]="lote.id">
                  {{ esPrimerLoteFEFO(i) ? '⭐ ' : '' }}{{ lote.codigoLote }} - Vence: {{ formatFechaVencimiento(lote.fechaVencimiento) }} ({{ getUrgenciaTexto(lote.diasHastaVencimiento) }}) - Stock: {{ lote.cantidadDisponible }}
                </option>
              }
            </select>
            @if (lotes.length > 0 && formData.loteId === lotes[0].id) {
              <small class="fefo-recomendado">⭐ Este es el lote recomendado por FEFO (vence primero)</small>
            }
          </div>

          <div class="form-group">
            <label for="cantidad">Cantidad *</label>
            <input
              type="number"
              id="cantidad"
              [(ngModel)]="formData.cantidad"
              name="cantidad"
              min="1"
              placeholder="0"
              required />
          </div>

          <div class="form-group">
            <label for="documento">Documento de Referencia</label>
            <input
              type="text"
              id="documento"
              [(ngModel)]="formData.documentoReferencia"
              name="documentoReferencia"
              placeholder="Ej: Receta médica #123" />
          </div>

          <div class="form-group full-width">
            <label for="motivo">Motivo / Observaciones</label>
            <textarea
              id="motivo"
              [(ngModel)]="formData.motivo"
              name="motivo"
              rows="3"
              placeholder="Indicaciones o motivo de la dispensación..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="toggleForm()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            Registrar Dispensación
          </button>
        </div>
      </form>
    </div>
  }

  
  <div class="dispensaciones-list">
    <h2>Mis Dispensaciones Recientes</h2>

    @if (dispensaciones.length === 0) {
      <div class="empty-state">
        <p>No hay dispensaciones registradas</p>
      </div>
    } @else {
      <div class="table-container">
        <table class="dispensaciones-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Producto</th>
              <th>Lote</th>
              <th>Cantidad</th>
              <th>Fecha</th>
              <th>Documento Ref.</th>
              <th>Motivo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (disp of dispensaciones; track disp.id) {
              <tr>
                <td>{{ disp.id }}</td>
                <td class="producto-name">{{ disp.productoNombre }}</td>
                <td>{{ disp.codigoLote }}</td>
                <td>{{ disp.cantidad }} unidades</td>
                <td>{{ formatDate(disp.ocurrioEn) }}</td>
                <td>{{ disp.documentoReferencia || '-' }}</td>
                <td>{{ disp.motivo || '-' }}</td>
                <td>
                  <button class="btn-action btn-pdf" (click)="descargarComprobante(disp.id)" title="Descargar comprobante PDF">
                    <i class="fas fa-file-pdf"></i> PDF
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <div class="info-card">
    <h3>Instrucciones - FEFO (First Expired, First Out)</h3>
    <ul>
      <li><strong>Seleccione el producto</strong> que va a dispensar</li>
      <li><strong>Los lotes se muestran ordenados por FEFO</strong> (el que vence primero aparece arriba ⭐)</li>
      <li>El sistema <strong>auto-selecciona el lote recomendado</strong> (próximo a vencer)</li>
      <li><strong>Ingrese la cantidad</strong> a dispensar (no puede exceder el stock disponible)</li>
      <li>Opcionalmente agregue el <strong>documento de referencia</strong> (receta, orden médica, etc.)</li>
      <li>Agregue <strong>observaciones o motivo</strong> de la dispensación si es necesario</li>
      <li>El sistema <strong>descontará automáticamente</strong> del inventario y generará el comprobante PDF</li>
      <li><strong>Normativa FEFO:</strong> Siempre use el lote que vence primero para minimizar pérdidas</li>
    </ul>
  </div>
</div>
