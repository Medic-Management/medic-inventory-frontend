<div class="ml-predictions-page">
  
  <div class="page-header">
    <h1>ğŸ¤– Predicciones de Machine Learning</h1>
    <button class="btn-reload" (click)="recargar()" [disabled]="loading">
      <span *ngIf="!loading">ğŸ”„ Actualizar</span>
      <span *ngIf="loading">â³ Cargando...</span>
    </button>
  </div>

  
  <div *ngIf="error" class="alert alert-error">
    <strong>Error:</strong> {{ error }}
  </div>

  
  <div *ngIf="loading && !error" class="loading-container">
    <div class="spinner"></div>
    <p>Analizando productos con Machine Learning...</p>
  </div>

  
  <div *ngIf="!loading && !error">
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-content">
          <p class="stat-label">Total Productos</p>
          <p class="stat-value">{{ totalProductos }}</p>
        </div>
      </div>

      <div class="stat-card stat-warning">
        <div class="stat-icon">ğŸ”¥</div>
        <div class="stat-content">
          <p class="stat-label">Con Alta Demanda</p>
          <p class="stat-value">{{ productosConPico }}</p>
        </div>
      </div>

      <div class="stat-card stat-danger">
        <div class="stat-icon">âš ï¸</div>
        <div class="stat-content">
          <p class="stat-label">Riesgo de Vencimiento</p>
          <p class="stat-value">{{ productosEnRiesgo }}</p>
        </div>
      </div>
    </div>

    <!-- HU-06 Escenario 2: Indicador de confianza del pronÃ³stico -->
    <div class="confianza-container">
      <div class="confianza-badge" [ngClass]="getConfianzaClass()">
        ğŸ“Š Confianza del PronÃ³stico: <strong>{{ getConfianzaLabel() }} ({{ confianzaPronostico }}%)</strong>
      </div>
    </div>

    <!-- HU-06 Escenario 2: Advertencia cuando confianza es baja -->
    <div *ngIf="mostrarAdvertenciaConfianza()" class="alert alert-warning confianza-warning">
      <h3>âš ï¸ Advertencia: Confianza Baja en el PronÃ³stico</h3>
      <p><strong>La confianza del pronÃ³stico es BAJA ({{ confianzaPronostico }}%)</strong>. Esto puede deberse a:</p>
      <ul>
        <li>ğŸ“‰ <strong>Datos histÃ³ricos insuficientes:</strong> Se requiere al menos 3 meses de datos para pronÃ³sticos confiables.</li>
        <li>ğŸ“Š <strong>Alta variabilidad en el consumo:</strong> Patrones irregulares dificultan las predicciones.</li>
        <li>ğŸ”„ <strong>Cambios recientes en la demanda:</strong> Eventos atÃ­picos afectan la precisiÃ³n del modelo.</li>
        <li>ğŸ“… <strong>Productos nuevos:</strong> Medicamentos sin historial suficiente para anÃ¡lisis.</li>
      </ul>
      <p><strong>ğŸ’¡ RecomendaciÃ³n:</strong> Utilice estas predicciones como referencia complementaria. Para decisiones crÃ­ticas, considere tambiÃ©n el criterio experto y la tendencia manual observada.</p>
    </div>


    <div class="tabs-container">
      <button
        class="tab"
        [class.active]="selectedTab === 'demanda'"
        (click)="selectTab('demanda')">
        ğŸ”¥ Picos de Demanda ({{ productosConPico }})
      </button>
      <button
        class="tab"
        [class.active]="selectedTab === 'vencimiento'"
        (click)="selectTab('vencimiento')">
        âš ï¸ Riesgo de Vencimiento ({{ productosEnRiesgo }})
      </button>
    </div>

    
    <div class="filters-container">
      <span class="filter-label">Filtrar por nivel:</span>
      <button
        class="filter-btn"
        [class.active]="selectedNivel === 'TODOS'"
        (click)="selectNivel('TODOS')">
        Todos
      </button>
      <button
        class="filter-btn filter-alto"
        [class.active]="selectedNivel === 'ALTO'"
        (click)="selectNivel('ALTO')">
        ğŸ”´ Alto
      </button>
      <button
        class="filter-btn filter-medio"
        [class.active]="selectedNivel === 'MEDIO'"
        (click)="selectNivel('MEDIO')">
        ğŸŸ¡ Medio
      </button>
      <button
        class="filter-btn filter-bajo"
        [class.active]="selectedNivel === 'BAJO'"
        (click)="selectNivel('BAJO')">
        ğŸŸ¢ Bajo
      </button>
    </div>

    
    <div class="predictions-table-card">
      <div *ngIf="prediccionesFiltradas.length === 0" class="empty-state">
        <p>ğŸ“­ No hay predicciones con este nivel de riesgo</p>
      </div>

      <table *ngIf="prediccionesFiltradas.length > 0" class="predictions-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Nivel</th>
            <th>Probabilidad</th>
            <th>RecomendaciÃ³n</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pred of prediccionesFiltradas"
              [class]="getNivelClass(pred.nivelRiesgo)">
            <td class="producto-cell">
              <strong>{{ pred.nombre }}</strong>
              <span class="producto-id">ID: {{ pred.productoId }}</span>
            </td>
            <td>
              <span class="badge" [class]="getNivelClass(pred.nivelRiesgo)">
                {{ pred.nivelRiesgo }}
              </span>
            </td>
            <td>
              <div class="progress-container">
                <div class="progress-bar"
                     [style.width.%]="getProbabilidadPorcentaje(pred.probabilidad)"
                     [class]="getNivelClass(pred.nivelRiesgo)">
                </div>
                <span class="progress-label">{{ getProbabilidadPorcentaje(pred.probabilidad) }}%</span>
              </div>
            </td>
            <td class="recomendacion-cell">
              {{ pred.recomendacion }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    
    <div class="info-box">
      <h3>â„¹ï¸ Acerca de las Predicciones</h3>
      <ul>
        <li><strong>Picos de Demanda:</strong> Identifica productos que tendrÃ¡n alta demanda en el prÃ³ximo mes basÃ¡ndose en patrones histÃ³ricos.</li>
        <li><strong>Riesgo de Vencimiento:</strong> Detecta productos con baja rotaciÃ³n que podrÃ­an vencerse antes de venderse.</li>
        <li><strong>Nivel de Riesgo:</strong> ALTO (â‰¥70%), MEDIO (40-69%), BAJO (<40%)</li>
        <li>Las predicciones se actualizan automÃ¡ticamente cada 24 horas.</li>
      </ul>
    </div>
  </div>
</div>
